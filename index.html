<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLPT N3 漢字レビュアー</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h1>漢字学習</h1>
        <p class="subtitle">JLPT N3</p>

        <!-- Фильтр -->
        <div class="toggle-section">
            <span id="all-label" class="toggle-label active">Все кандзи</span>
            <input type="checkbox" id="filter-toggle" class="toggle-switch">
            <span id="sel-label" class="toggle-label inactive">Избранные (<span id="count">0</span>)</span>
        </div>

        <!-- Режим -->
        <div class="toggle-section">
            <span id="flash-label" class="toggle-label active">Flashcards</span>
            <input type="checkbox" id="mode-toggle" class="toggle-switch">
            <span id="quiz-label" class="toggle-label inactive">Quiz</span>
        </div>

        <!-- Карточки -->
        <div id="flashcard-view">
            <div class="card-container">
                <div class="card" onclick="app.flip()">
                    <div class="card-inner">
                        <div class="card-face">
                            <p id="kanji" class="kanji"></p>
                        </div>
                        <div class="card-face card-back">
                            <div>
                                <p class="section-title">Meaning</p>
                                <p id="meaning" class="meaning"></p>
                                <p class="section-title">Readings</p>
                                <div class="readings">
                                    <div>
                                        <p class="reading-label">On'yomi</p>
                                        <p id="onyomi" class="reading-value"></p>
                                    </div>
                                    <div>
                                        <p class="reading-label">Kun'yomi</p>
                                        <p id="kunyomi" class="reading-value"></p>
                                    </div>
                                </div>
                                <p class="section-title" style="margin-top: 1rem;">Example</p>
                                <p id="example" class="example"></p>
                                <p id="example-ru" class="example-russian"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="progress" class="progress"></div>
        </div>

        <!-- Квиз -->
        <div id="quiz-view" class="hidden">
            <div class="quiz-container">
                <div id="score" class="score"></div>
                <div id="quiz-content" class="quiz-content">
                    <p id="quiz-word" class="quiz-word"></p>
                    <div id="options" class="quiz-options"></div>
                </div>
                <div id="final" class="final hidden">
                    <h2>Quiz Complete!</h2>
                    <p id="final-score" class="final-score"></p>
                </div>
            </div>
            <div id="quiz-progress" class="progress"></div>
        </div>

        <!-- Кнопки -->
        <div class="button-container">
            <button id="prev" class="btn-prev">Previous</button>
            <button id="next" class="btn-next">Next</button>
        </div>
    </div>

    <script src="n3_kanji.js"></script> <!-- Подключение массива с переменной kanjiDataN3 -->

    <script>
        const app = {
            allKanji: kanjiDataN3,
            selected: new Set([
                "両", "争", "仏", "令", "余", "候", "兆", "具", "刊", "刻",
                "副", "労", "勢", "厚", "器", "坂", "境", "実", "寄", "導", 
                "岩", "岸", "州", "希", "師", "底", "府", "徒", "御", "念", 
                "政", "散", "査", "栄", "極", "武", "犯", "状", "率", "球", 
                "略", "省", "競", "筆", "管", "築", "編", "老", "臣", "航", 
                "芸", "複", "訓", "講", "議"
            ]),
            active: [],
            idx: 0,
            quizIdx: 0,
            quizScore: 0,
            order: [],
            quizOrder: [],
            correctAns: '',
            answered: false,
            isQuiz: false,
            filtered: false,
            els: {},

            init() {
                this.els = {
                    card: document.querySelector('.card'),
                    kanji: document.getElementById('kanji'),
                    meaning: document.getElementById('meaning'),
                    onyomi: document.getElementById('onyomi'),
                    kunyomi: document.getElementById('kunyomi'),
                    example: document.getElementById('example'),
                    exampleRu: document.getElementById('example-ru'),
                    progress: document.getElementById('progress'),
                    flashView: document.getElementById('flashcard-view'),
                    quizView: document.getElementById('quiz-view'),
                    score: document.getElementById('score'),
                    quizContent: document.getElementById('quiz-content'),
                    final: document.getElementById('final'),
                    finalScore: document.getElementById('final-score'),
                    quizWord: document.getElementById('quiz-word'),
                    options: document.getElementById('options'),
                    quizProgress: document.getElementById('quiz-progress'),
                    prev: document.getElementById('prev'),
                    next: document.getElementById('next'),
                    allLabel: document.getElementById('all-label'),
                    selLabel: document.getElementById('sel-label'),
                    flashLabel: document.getElementById('flash-label'),
                    quizLabel: document.getElementById('quiz-label'),
                    count: document.getElementById('count')
                };

                this.els.count.textContent = this.selected.size;
                this.updateActive();
                
                document.getElementById('mode-toggle').addEventListener('change', e => {
                    this.isQuiz = e.target.checked;
                    this.toggleLabels(this.els.flashLabel, this.els.quizLabel, this.isQuiz);
                    this.updateView();
                });

                document.getElementById('filter-toggle').addEventListener('change', e => {
                    this.filtered = e.target.checked;
                    this.toggleLabels(this.els.allLabel, this.els.selLabel, this.filtered);
                    this.updateActive();
                    this.updateView();
                });

                this.els.next.addEventListener('click', () => this.handleNext());
                this.els.prev.addEventListener('click', () => this.handlePrev());
                
                document.addEventListener('keydown', e => {
                    if (!this.isQuiz) {
                        if (e.key === ' ') { e.preventDefault(); this.flip(); }
                        if (e.key === 'ArrowRight') this.nextCard();
                        if (e.key === 'ArrowLeft') this.prevCard();
                    }
                });

                this.updateView();
            },

            shuffle(arr) {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            },

            toggleLabels(off, on, active) {
                if (active) {
                    off.classList.remove('active');
                    off.classList.add('inactive');
                    on.classList.remove('inactive');
                    on.classList.add('active');
                } else {
                    off.classList.remove('inactive');
                    off.classList.add('active');
                    on.classList.remove('active');
                    on.classList.add('inactive');
                }
            },

            updateActive() {
                this.active = this.filtered 
                    ? this.allKanji.filter(k => this.selected.has(k.kanji))
                    : this.allKanji.filter(k => !this.selected.has(k.kanji));
                this.idx = 0;
                this.order = Array.from(Array(this.active.length).keys());
                this.shuffle(this.order);
            },

            flip() {
                this.els.card.classList.toggle('is-flipped');
            },

            renderCard() {
                if (!this.active.length) {
                    this.els.kanji.textContent = '—';
                    this.els.meaning.textContent = 'Нет кандзи';
                    this.els.onyomi.textContent = '-';
                    this.els.kunyomi.textContent = '-';
                    this.els.example.textContent = '-';
                    this.els.exampleRu.textContent = '';
                    this.els.progress.textContent = 'No kanji available';
                    return;
                }
                
                const k = this.active[this.order[this.idx]];
                
                this.els.kanji.textContent = k.kanji;
                this.els.progress.textContent = `Card ${this.idx + 1} of ${this.active.length}`;
                
                if (this.els.card.classList.contains('is-flipped')) {
                    this.els.card.classList.remove('is-flipped');
                    setTimeout(() => {
                        this.updateCardBack(k);
                    }, 600);
                } else {
                    this.updateCardBack(k);
                }
            },

            updateCardBack(k) {
                this.els.meaning.textContent = k.meaning;
                this.els.onyomi.textContent = k.onyomi || '-';
                this.els.kunyomi.textContent = k.kunyomi || '-';
                this.els.example.textContent = `${k.example_word} (${k.example_hiragana})`;
                this.els.exampleRu.textContent = k.example_russian;
            },

            nextCard() {
                this.idx = (this.idx + 1) % this.active.length;
                this.renderCard();
            },

            prevCard() {
                this.idx = (this.idx - 1 + this.active.length) % this.active.length;
                this.renderCard();
            },

            startQuiz() {
                if (!this.active.length) {
                    this.els.quizContent.classList.add('hidden');
                    this.els.final.classList.remove('hidden');
                    this.els.score.textContent = 'No kanji available';
                    this.els.finalScore.textContent = 'Добавьте кандзи в список';
                    this.els.next.textContent = 'Back';
                    return;
                }
                
                this.quizScore = 0;
                this.quizIdx = 0;
                this.quizOrder = Array.from(Array(this.active.length).keys());
                this.shuffle(this.quizOrder);
                this.els.quizContent.classList.remove('hidden');
                this.els.final.classList.add('hidden');
                this.els.next.textContent = 'Next Question';
                this.genQuestion();
            },

            genQuestion() {
                if (this.quizIdx >= this.quizOrder.length) {
                    this.showFinal();
                    return;
                }

                this.answered = false;
                this.updateScore();
                
                const correct = this.active[this.quizOrder[this.quizIdx]];
                this.els.quizWord.textContent = correct.example_word;
                this.correctAns = `${correct.example_hiragana} (${correct.example_russian})`;
                
                const opts = [this.correctAns];
                const used = [this.quizOrder[this.quizIdx]];

                while (opts.length < 4 && opts.length < this.active.length) {
                    const i = Math.floor(Math.random() * this.active.length);
                    if (used.includes(i)) continue;
                    used.push(i);
                    const d = this.active[i];
                    const t = `${d.example_hiragana} (${d.example_russian})`;
                    if (!opts.includes(t)) opts.push(t);
                }

                this.shuffle(opts);
                this.els.options.innerHTML = '';
                opts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.textContent = opt;
                    btn.className = 'quiz-option';
                    btn.onclick = () => this.selectAns(btn);
                    this.els.options.appendChild(btn);
                });
            },

            selectAns(btn) {
                if (this.answered) return;
                this.answered = true;
                
                if (btn.textContent === this.correctAns) {
                    this.quizScore++;
                    btn.classList.add('correct');
                } else {
                    btn.classList.add('incorrect');
                    [...this.els.options.children].forEach(b => {
                        if (b.textContent === this.correctAns) b.classList.add('correct');
                    });
                }
                this.updateScore();
            },

            updateScore() {
                this.els.score.textContent = `Score: ${this.quizScore}`;
                this.els.quizProgress.textContent = `Question ${this.quizIdx + 1} of ${this.active.length}`;
            },

            showFinal() {
                this.els.quizContent.classList.add('hidden');
                this.els.final.classList.remove('hidden');
                this.els.quizProgress.textContent = '';
                this.els.score.textContent = 'Quiz Finished!';
                this.els.finalScore.textContent = `Your score: ${this.quizScore} / ${this.active.length}`;
                this.els.next.textContent = 'Restart Quiz';
            },

            updateView() {
                if (this.isQuiz) {
                    this.els.flashView.classList.add('hidden');
                    this.els.quizView.classList.remove('hidden');
                    this.els.prev.classList.add('hidden');
                    this.startQuiz();
                } else {
                    this.els.flashView.classList.remove('hidden');
                    this.els.quizView.classList.add('hidden');
                    this.els.prev.classList.remove('hidden');
                    this.els.next.textContent = 'Next';
                    this.renderCard();
                }
            },

            handleNext() {
                if (this.isQuiz) {
                    if (this.els.next.textContent === 'Restart Quiz') {
                        this.startQuiz();
                    } else if (this.els.next.textContent === 'Back') {
                        document.getElementById('mode-toggle').checked = false;
                        this.isQuiz = false;
                        this.toggleLabels(this.els.flashLabel, this.els.quizLabel, false);
                        this.updateView();
                    } else {
                        this.quizIdx++;
                        this.genQuestion();
                    }
                } else {
                    this.nextCard();
                }
            },

            handlePrev() {
                if (!this.isQuiz) this.prevCard();
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>